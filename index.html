<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>bowbowè¨˜å¸³æœ¬</title>

  <meta name="apple-mobile-web-app-title" content="bowbowè¨˜å¸³æœ¬">
  <meta name="application-name" content="bowbowè¨˜å¸³æœ¬">

  <link rel="apple-touch-icon" href="icon.png">
  <link rel="icon" type="image/png" href="icon.png">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            milk: "#FFF7FA",
            milk2: "#FFEFF4",
            berry: "#FF6C9F",
            blush: "#FFB7CE",
            pastel: "#FFE3ED",
            ink: "#2b2b3c",
            success: "#10B981", // ç¶ è‰²
            danger: "#EF4444",  // ç´…è‰²
          },
          boxShadow: {
            soft: "0 0 0 rgba(0,0,0,0)",
          },
        },
      },
    };
  </script>

  <style>
    .slide {
      animation: slideDown .25s ease-out;
    }
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-4px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    button {
      -webkit-tap-highlight-color: transparent;
    }

    input[type="date"],
    input[type="month"] {
      width: 100% !important;
      max-width: 100% !important;
      box-sizing: border-box;
      appearance: none;
      -webkit-appearance: none;
      padding-left: 8px !important;
      padding-right: 8px !important;
    }

    .btn-selected {
      background-color: #FF6C9F !important;
      color: #ffffff !important;
    }

    .shadow-soft {
      box-shadow: none !important;
    }

    .sub-popup {
      position: absolute;
      z-index: 50;
      background: white;
      border: 1px solid #FFD6E8;
      border-radius: 12px;
      padding: 8px;
      display: none;
      flex-wrap: wrap;
      gap: 6px;
      max-width: 160px;
      box-shadow: 0 4px 10px rgba(255, 150, 186, 0.25);
    }
    
    /* Checkbox è‡ªè¨‚æ¨£å¼ */
    .custom-checkbox {
      accent-color: #FF6C9F;
      width: 18px;
      height: 18px;
    }
    
    .bill-done {
      text-decoration: line-through;
      color: #cbd5e1; /* slate-300 */
    }
  </style>
</head>

<body class="min-h-screen bg-milk text-ink">
  <div class="max-w-xl mx-auto px-4 py-6 space-y-6">

    <section class="bg-white rounded-2xl shadow-soft border border-pastel p-5">
      <h1 class="text-xl font-bold flex items-center gap-2">âœ¨ æœ¬æœˆç¸½è¦½</h1>

      <div class="grid grid-cols-3 text-center mt-4 text-sm">
        <div>
          <p class="text-slate-500">æ”¶å…¥</p>
          <p id="sumIncome" class="text-lg font-semibold text-green-600">$0</p>
        </div>
        <div>
          <p class="text-slate-500">å„²è“„</p>
          <p id="sumSaving" class="text-lg font-semibold text-blue-600">$0</p>
        </div>
        <div>
          <p class="text-slate-500">æ”¯å‡º</p>
          <p id="sumExpense" class="text-lg font-semibold text-red-500">$0</p>
        </div>
      </div>

      <div class="mt-4 flex items-center gap-2">
        <label class="text-xs text-slate-500">æœˆä»½</label>
        <input
          id="monthFilter"
          type="month"
          class="px-2 py-1.5 rounded-xl border border-slate-300 text-xs bg-white"
        />
      </div>
      
      <div class="mt-4">
        <canvas id="expensePieChart" height="130" style="max-width:180px; margin:0 auto;"></canvas>
      </div>
    </section>

    <section class="bg-white rounded-2xl shadow-soft border border-pastel p-5 border-l-4 border-l-berry">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-lg font-bold flex items-center gap-2 text-berry">ğŸ“ ä»£ç¹³æ¸…å–®è©¦ç®—</h2>
        <button id="toggleBillBtn" class="text-xs bg-milk2 px-2 py-1 rounded-lg text-berry">
          æ”¶åˆ â–¼
        </button>
      </div>

      <div id="billSectionContent">
        <div class="bg-milk2 rounded-xl p-3 mb-4">
          <div class="flex justify-between text-sm mb-1">
            <span class="text-slate-500">æœ¬æœˆç¸½æ”¶å…¥</span>
            <span id="calcIncome" class="font-medium">$0</span>
          </div>
          <div class="flex justify-between text-sm mb-2 border-b border-white pb-2">
            <span class="text-slate-500">æ‰£é™¤ä»£ç¹³ç¸½é¡</span>
            <span id="calcBills" class="font-medium text-slate-600">-$0</span>
          </div>
          <div class="flex justify-between text-base font-bold">
            <span>å‰©é¤˜å¯æ”¯é…</span>
            <span id="calcBalance" class="text-berry">$0</span>
          </div>
          <p class="text-[10px] text-slate-400 mt-2 text-center">
            * æ”¶å…¥ä¾æ“šä¸Šæ–¹æœ¬æœˆç´€éŒ„è‡ªå‹•è¨ˆç®—
          </p>
        </div>

        <div id="billList" class="space-y-2"></div>

        <button id="addBillBtn" class="w-full mt-3 py-2 border border-dashed border-berry text-berry rounded-xl text-xs font-medium hover:bg-milk2 transition">
          ï¼‹ æ–°å¢ä»£ç¹³é …ç›®
        </button>
      </div>
    </section>


    <section class="bg-white rounded-2xl shadow-soft border border-pastel p-5">
      <h2 class="text-lg font-semibold flex items-center gap-2">ğŸ“ æ–°å¢è¨˜éŒ„</h2>

      <div class="grid grid-cols-3 gap-3 mt-4">
        <button id="btnIncome" type="button"
          class="py-2 rounded-xl bg-milk2 text-ink text-sm font-medium">ğŸ’— æ”¶å…¥</button>
        <button id="btnExpense" type="button"
          class="py-2 rounded-xl bg-milk2 text-ink text-sm font-medium">ğŸ§¾ æ”¯å‡º</button>
        <button id="btnSaving" type="button"
          class="py-2 rounded-xl bg-milk2 text-ink text-sm font-medium">ğŸ· å„²è“„</button>
      </div>

      <form id="entryForm" class="mt-5 space-y-4 hidden slide">
        <div>
          <label class="text-xs">é‡‘é¡</label>
          <input
            id="amountInput"
            type="number"
            inputmode="numeric" 
            pattern="[0-9]*"
            class="w-full mt-2 mb-2 px-3 py-2 rounded-xl border border-slate-300 text-sm bg-white"
            placeholder="è«‹è¼¸å…¥é‡‘é¡"
          />
        </div>

        <div>
          <label class="text-xs">æ—¥æœŸ</label>
          <input
            id="dateInput"
            type="date"
            class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300 text-sm"
          />
        </div>

        <div id="expenseCategoryBlock" class="hidden">
          <label class="text-xs">ä¸»è¦åˆ†é¡</label>
          <div id="mainCategoryButtons" class="grid grid-cols-3 gap-2 mt-2 text-xs"></div>
        </div>

        <div>
          <label class="text-xs">å‚™è¨»</label>
          <input
            id="noteInput"
            type="text"
            maxlength="40"
            class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300 text-sm"
            placeholder="å¯ç•™ç™½"
          />
        </div>

        <button
          type="submit"
          class="w-full py-2.5 bg-berry text-white rounded-xl shadow-soft text-sm"
        >
          ï¼‹ åŠ å…¥ç´€éŒ„
        </button>
        <p id="formError" class="text-xs text-red-500 hidden"></p>
      </form>
    </section>

    <section class="p-4 bg-white rounded-xl border border-pastel">
      <button
        id="toggleRecords"
        class="w-full flex justify-between items-center py-2 px-3 bg-milk2 rounded-xl text-sm font-semibold"
      >
        <span>ğŸ“‹ æœ¬æœˆæ”¯å‡ºæ˜ç´°</span>
        <span id="recordsArrow">â–¼</span>
      </button>

      <div id="recordsContent" class="mt-3 space-y-2 hidden">
        <div id="recordCount" class="text-xs text-slate-500"></div>
        <div id="mobileList" class="space-y-3"></div>
        <p id="emptyHint" class="text-xs text-slate-400 mt-2 hidden">ç›®å‰æ²’æœ‰ç´€éŒ„ã€‚</p>
      </div>
    </section>

    <section class="p-4 bg-white rounded-xl border border-pastel mt-4">
      <button
        id="toggleBudgetBtn"
        class="w-full flex justify-between items-center py-2 px-3 bg-milk2 rounded-xl text-sm font-semibold"
      >
        <span>ğŸ“‚ åˆ†é¡é ç®—ç®¡ç†</span>
        <span id="budgetArrow">â–¼</span>
      </button>

      <div id="budgetContent" class="mt-3 hidden">
        <div id="budgetInputs" class="space-y-2"></div>
        <button
          id="saveBudgetBtn"
          class="mt-3 w-full bg-pink-300 text-white py-2 rounded-xl"
        >
          å„²å­˜åˆ†é¡é ç®—
        </button>
      </div>
    </section>

  </div>

  <div id="categoryBudgetStatus" class="space-y-1 mt-3 max-w-xl mx-auto px-4 pb-10"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    /* ------- åˆ†é¡è³‡æ–™ ------- */
    const categoryData = {
      "ğŸ± é£²é£Ÿ": ["æ—©é¤", "åˆé¤", "æ™šé¤", "é»å¿ƒ", "å®µå¤œ", "å°åƒ", "é£²æ–™", "å…¶ä»–"],
      "ğŸš— äº¤é€š": ["å¤§çœ¾é‹è¼¸", "åŠ æ²¹", "Uberï¼è¨ˆç¨‹è»Š", "åœè»Šè²»", "å…¶ä»–"],
      "ğŸ›’ ç”Ÿæ´»": ["å€‹äººç”¨å“", "å®¶ç”¨æ¸…æ½”ç”¨å“", "è¡›ç”Ÿç”¨å“", "æ–‡å…·å°ç‰©", "äº”é‡‘å·¥å…·", "å…¶ä»–"],
      "ğŸ›ï¸ è³¼ç‰©": ["è¡£æœ", "é‹å­", "é…ä»¶", "ç¾å¦", "ä¿é¤Šå“", "å±…å®¶å°ç‰©", "å…¶ä»–"],
      "ğŸ’³ å¸³å–®": ["å¡è²»", "æ‰‹æ©Ÿè²»", "å¥ä¿è²»", "æˆ¿ç§Ÿ", "é›»è²»", "æ°´è²»", "ç¶²è·¯", "å…¶ä»–"],
      "ğŸ± è²“å’ª": ["ç½é ­", "ä¹¾ä¹¾", "é›¶é£Ÿ", "è²“ç ‚", "ç©å…·", "é é˜²é‡ï¼é†«ç™‚", "ç”¨å“", "å…¶ä»–"],
      "ğŸ’– ç¾å®¹": ["ç¾ç”²", "ç¾ç«", "è‡‰éƒ¨ä¿é¤Š", "é ­é«®", "å…¶ä»–"],
      "ğŸ® å¨›æ¨‚": ["é›»å½±", "KTV", "éŠæˆ²", "èšæœƒ", "é–±è®€ï¼å­¸ç¿’", "å…¶ä»–"],
      "ğŸ¥ é†«ç™‚": ["çœ‹è¨º", "è—¥å“", "å¥åº·æª¢æŸ¥", "å…¶ä»–é†«ç™‚"],
      "âœˆï¸ æ—…éŠ": ["ä½å®¿", "äº¤é€š", "é–€ç¥¨", "ä¼´æ‰‹ç¦®", "å…¶ä»–"],
      "ğŸ€ å…¶ä»–": ["è‡¨æ™‚é–‹éŠ·", "å°é¡èŠ±è²»", "å…¶ä»–"]
    };

    const STORAGE_KEY = "cute-book-entries-v2";
    const CATEGORY_BUDGET_KEY = "cute-budget-category-v1";
    const FIXED_BILLS_KEY = "cute-fixed-bills-v1"; // NEW Key

    /* ------- DOM ------- */
    const sumIncome = document.getElementById("sumIncome");
    const sumSaving = document.getElementById("sumSaving");
    const sumExpense = document.getElementById("sumExpense");

    const monthFilter = document.getElementById("monthFilter");
    const btnIncome = document.getElementById("btnIncome");
    const btnExpense = document.getElementById("btnExpense");
    const btnSaving = document.getElementById("btnSaving");

    const entryForm = document.getElementById("entryForm");
    const amountInput = document.getElementById("amountInput");
    const dateInput = document.getElementById("dateInput");
    const noteInput = document.getElementById("noteInput");
    const formError = document.getElementById("formError");

    const expenseCategoryBlock = document.getElementById("expenseCategoryBlock");
    const mainCategoryButtons = document.getElementById("mainCategoryButtons");

    const recordCount = document.getElementById("recordCount");
    const mobileList = document.getElementById("mobileList");
    const emptyHint = document.getElementById("emptyHint");

    const budgetInputs = document.getElementById("budgetInputs");
    const saveBudgetBtn = document.getElementById("saveBudgetBtn");
    const budgetBtn = document.getElementById("toggleBudgetBtn");
    const budgetContent = document.getElementById("budgetContent");
    const budgetArrow = document.getElementById("budgetArrow");

    const categoryBudgetStatusBox = document.getElementById("categoryBudgetStatus");
    
    // NEW DOM for Bills
    const billListEl = document.getElementById("billList");
    const addBillBtn = document.getElementById("addBillBtn");
    const calcIncomeEl = document.getElementById("calcIncome");
    const calcBillsEl = document.getElementById("calcBills");
    const calcBalanceEl = document.getElementById("calcBalance");
    const toggleBillBtn = document.getElementById("toggleBillBtn");
    const billSectionContent = document.getElementById("billSectionContent");

    /* ------- ç‹€æ…‹ ------- */
    let entries = [];
    let selectedType = null;
    let selectedMainCategory = null;
    let selectedSubCategory = null;
    let categoryBudgets = {};
    let pieChart = null;
    
    // é è¨­ä»£ç¹³æ¸…å–® (ä¾ç…§å¦³çš„æˆªåœ–è¨­å®š)
    let fixedBills = [
      { id: 'b1', name: 'æˆ¿ç§Ÿ+æ°´é›»', amount: 18186, done: false },
      { id: 'b2', name: 'å¥ä¿', amount: 1982, done: false },
      { id: 'b3', name: 'å¥ä¿', amount: 826, done: false },
      { id: 'b4', name: 'æ‰‹æ©Ÿè²»', amount: 1657, done: false },
      { id: 'b5', name: 'å¡è²»', amount: 16393, done: true } // æˆªåœ–ä¸­å·²æ‰“å‹¾
    ];

    function showError(msg) {
      formError.textContent = msg;
      formError.classList.remove("hidden");
    }

    // âš ï¸ æ›¿æ›é€™è£¡ï¼è«‹ä½¿ç”¨æ‚¨åœ¨æ­¥é©Ÿä¸‰ä¸­éƒ¨ç½² Web App å¾Œçš„ã€Œå·²éƒ¨ç½²ç¶²å€ã€
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyePbfCt3HsLD-cKRqZfREIsB07FGiecvFiPiXpGMVHWAdC0_JgmOW0OzvRXlzXqFV4/exec'; 

    /**
     * è™•ç†æ–°å¢æˆ–åˆªé™¤è«‹æ±‚
     */
    async function sendActionToSheet(data) {
        const isDelete = data.action === 'DELETE';
        const actionName = isDelete ? 'åˆªé™¤' : 'æ–°å¢';
        
        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(data),
                redirect: 'follow'
            });

            const result = await response.json();

            if (result.status === 'success') {
                console.log(`âœ… è³‡æ–™${actionName}æˆåŠŸ:`, result.message);
                return true;
            } else {
                console.error(`âŒ è³‡æ–™${actionName}å¤±æ•—:`, result.message);
                alert(`${actionName}å¤±æ•—ï¼š${result.message}`);
                return false;
            }

        } catch (err) {
            console.error(`âŒ ${actionName}æ™‚ç™¼ç”ŸéŒ¯èª¤:`, err);
            alert(`${actionName}ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–å¾Œå°`);
            return false;
        }
    }

    /**
     * å¾ Google Sheet (doGet) è®€å–æ‰€æœ‰è³‡æ–™ä¸¦æ›´æ–°æœ¬åœ°
     */
    async function loadDataFromSheet() {
        console.log('ğŸ”„ å˜—è©¦å¾é›²ç«¯åŒæ­¥è³‡æ–™...');
        try {
            const response = await fetch(SCRIPT_URL, { 
                method: 'GET' 
            });

            const result = await response.json();

            if (result.status === 'success' && Array.isArray(result.data)) {
                entries = result.data.map(e => ({
                    ...e,
                    amount: parseFloat(e.amount),
                    id: String(e.id)
                }));
                
                saveEntries();
                console.log(`âœ… é›²ç«¯åŒæ­¥å®Œæˆï¼å…±è¼‰å…¥ ${entries.length} ç­†ç´€éŒ„ã€‚`);
                render(); // åŒæ­¥å®Œå† render ä¸€æ¬¡ç¢ºä¿æ•¸æ“šæ­£ç¢º
                return true;
            } else {
                console.error('âŒ é›²ç«¯è³‡æ–™è®€å–å¤±æ•—:', result.message);
                return false;
            }
        } catch (err) {
            console.error('âŒ é›²ç«¯é€£ç·šéŒ¯èª¤ (GET):', err);
            return false;
        }
    }

    /* =========================================
        åˆå§‹åŒ–
    ========================================= */
    async function init() {
      const t = new Date();
      const yyyy = t.getFullYear();
      const mm = String(t.getMonth() + 1).padStart(2, "0");
      const dd = String(t.getDate()).padStart(2, "0");
      dateInput.value = `${yyyy}-${mm}-${dd}`;
      monthFilter.value = `${yyyy}-${mm}`;

      loadEntries();        // å…ˆè®€æœ¬åœ°ï¼Œè®“ç•«é¢å¿«ä¸€é»
      loadCategoryBudgets();
      loadFixedBills();     // NEW è®€å–å›ºå®šæ”¯å‡º
      renderBudgetInputs();
      renderFixedBills();   // NEW æ¸²æŸ“ä»£ç¹³æ¸…å–®
      render();

      await loadDataFromSheet(); // èƒŒæ™¯åŒæ­¥é›²ç«¯
    }

    /* =========================================
        LocalStorage
    ========================================= */
    function loadEntries() {
      const raw = localStorage.getItem(STORAGE_KEY);
      entries = raw ? JSON.parse(raw) : [];
    }

    function saveEntries() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
    }

    function loadCategoryBudgets() {
      const raw = localStorage.getItem(CATEGORY_BUDGET_KEY);
      categoryBudgets = raw ? JSON.parse(raw) : {};
    }

    function saveCategoryBudgets() {
      localStorage.setItem(CATEGORY_BUDGET_KEY, JSON.stringify(categoryBudgets));
    }
    
    // NEW LocalStorage for Bills
    function loadFixedBills() {
      const raw = localStorage.getItem(FIXED_BILLS_KEY);
      // å¦‚æœæœ¬åœ°æœ‰å­˜ï¼Œå°±ç”¨æœ¬åœ°çš„ï¼›å¦‚æœæ²’æœ‰ï¼Œå°±ç”¨é è¨­çš„ (åŒ…å«å¦³æˆªåœ–é‚£äº›)
      if (raw) {
        fixedBills = JSON.parse(raw);
      } else {
        saveFixedBills(); // å­˜å…¥é è¨­å€¼
      }
    }
    
    function saveFixedBills() {
      localStorage.setItem(FIXED_BILLS_KEY, JSON.stringify(fixedBills));
      renderFixedBills(); // å­˜æª”å¾Œé‡ç¹ª
    }

    /* =========================================
        Money Format
    ========================================= */
    function formatMoney(n) {
      if (!n) return "$0";
      return (
        "$" +
        n
          .toFixed(0)
          .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      );
    }

    /* =========================================
        NEW FEATURE: ä»£ç¹³æ¸…å–®é‚è¼¯
    ========================================= */
    function renderFixedBills() {
      billListEl.innerHTML = "";
      
      let totalBills = 0;
      
      fixedBills.forEach((bill, index) => {
        totalBills += Number(bill.amount);
        
        const row = document.createElement("div");
        row.className = "flex items-center gap-2 text-sm py-1";
        
        // Checkbox
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.className = "custom-checkbox flex-shrink-0";
        checkbox.checked = bill.done;
        checkbox.onclick = () => {
          fixedBills[index].done = checkbox.checked;
          saveFixedBills();
        };

        // Name Input
        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.value = bill.name;
        nameInput.className = `w-full bg-transparent border-b border-transparent focus:border-slate-300 outline-none px-1 ${bill.done ? 'bill-done' : ''}`;
        nameInput.placeholder = "é …ç›®åç¨±";
        nameInput.onchange = (e) => {
          fixedBills[index].name = e.target.value;
          saveFixedBills();
        };

        // Amount Input
        const amtInput = document.createElement("input");
        amtInput.type = "number";
        amtInput.value = bill.amount;
        amtInput.className = `w-20 text-right bg-transparent border-b border-transparent focus:border-slate-300 outline-none px-1 ${bill.done ? 'bill-done' : ''}`;
        amtInput.placeholder = "$";
        amtInput.onchange = (e) => {
          fixedBills[index].amount = Number(e.target.value);
          saveFixedBills();
        };

        // Delete Btn
        const delBtn = document.createElement("button");
        delBtn.textContent = "Ã—";
        delBtn.className = "text-slate-300 px-2 text-lg hover:text-red-400";
        delBtn.onclick = () => {
          if (confirm(`åˆªé™¤ ${bill.name}ï¼Ÿ`)) {
            fixedBills.splice(index, 1);
            saveFixedBills();
          }
        };

        row.appendChild(checkbox);
        row.appendChild(nameInput);
        row.appendChild(amtInput);
        row.appendChild(delBtn);
        billListEl.appendChild(row);
      });
      
      // æ›´æ–°è©¦ç®—å€å¡Šæ•¸å­—
      updateBillCalc(totalBills);
    }

    function updateBillCalc(totalBills) {
      // 1. å–å¾—æœ¬æœˆç¸½æ”¶å…¥
      const list = getFilteredEntries();
      let currentMonthIncome = 0;
      list.forEach(e => {
        if (e.type === 'income') currentMonthIncome += e.amount;
      });

      // 2. è¨ˆç®—
      const balance = currentMonthIncome - totalBills;

      // 3. æ¸²æŸ“
      calcIncomeEl.textContent = formatMoney(currentMonthIncome);
      calcBillsEl.textContent = "-" + formatMoney(totalBills);
      
      calcBalanceEl.textContent = formatMoney(balance);
      
      // é¡è‰²è™•ç†ï¼šé€æ”¯è®Šç´…ï¼Œæœ‰éŒ¢è®Šç¶ 
      if (balance < 0) {
        calcBalanceEl.classList.remove("text-berry");
        calcBalanceEl.classList.add("text-danger");
      } else {
        calcBalanceEl.classList.remove("text-danger");
        calcBalanceEl.classList.add("text-berry"); // æˆ– success
      }
    }

    // æ–°å¢ä»£ç¹³æŒ‰éˆ•äº‹ä»¶
    addBillBtn.onclick = () => {
      fixedBills.push({
        id: Date.now().toString(),
        name: "",
        amount: 0,
        done: false
      });
      saveFixedBills();
    };

    // æ”¶åˆæŒ‰éˆ•äº‹ä»¶
    toggleBillBtn.onclick = () => {
       const isHidden = billSectionContent.classList.contains("hidden");
       if (isHidden) {
         billSectionContent.classList.remove("hidden");
         toggleBillBtn.textContent = "æ”¶åˆ â–¼";
       } else {
         billSectionContent.classList.add("hidden");
         toggleBillBtn.textContent = "å±•é–‹ â–²";
       }
    };


    /* =========================================
        åˆ†é¡æ¸²æŸ“
    ========================================= */
    function renderMainCategories() {
      mainCategoryButtons.innerHTML = "";
      let openedPopup = null;

      Object.keys(categoryData).forEach((cat) => {
        const wrap = document.createElement("div");
        wrap.className = "relative";

        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = cat;
        btn.dataset.cat = cat; 
        btn.className = "w-full py-2 px-2 bg-milk2 border border-pastel rounded-xl text-xs";

        const popup = document.createElement("div");
        popup.className = "sub-popup";

        categoryData[cat].forEach((sub) => {
          const sbtn = document.createElement("button");
          sbtn.type = "button";
          sbtn.textContent = sub;
          sbtn.className = "px-3 py-1 bg-white border border-pastel rounded-full text-[11px]";

          sbtn.addEventListener("click", () => {
            selectedMainCategory = cat;
            selectedSubCategory = sub;

            mainCategoryButtons
              .querySelectorAll(".sub-popup button")
              .forEach((b) => b.classList.remove("btn-selected"));
            sbtn.classList.add("btn-selected");

            mainCategoryButtons.querySelectorAll("button").forEach((b) => {
              if (b.dataset.cat) b.textContent = b.dataset.cat;
            });
            btn.textContent = `${cat}ï½œ${sub}`;
            popup.style.display = "none";
            openedPopup = null;
          });
          popup.appendChild(sbtn);
        });

        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          mainCategoryButtons.querySelectorAll("button").forEach((b) => {
            if (b.dataset.cat) b.textContent = b.dataset.cat;
          });

          if (openedPopup && openedPopup !== popup) {
            openedPopup.style.display = "none";
          }
          const open = popup.style.display !== "flex";
          popup.style.display = open ? "flex" : "none";
          openedPopup = open ? popup : null;
        });

        wrap.appendChild(btn);
        wrap.appendChild(popup);
        mainCategoryButtons.appendChild(wrap);
      });

      document.addEventListener("click", (e) => {
        if (!mainCategoryButtons.contains(e.target)) {
          mainCategoryButtons
            .querySelectorAll(".sub-popup")
            .forEach((p) => (p.style.display = "none"));
          openedPopup = null;
        }
      });
    }

    /* =========================================
        é¡å‹åˆ‡æ›
    ========================================= */
    function highlightType(type) {
      [btnIncome, btnExpense, btnSaving].forEach((btn) =>
        btn.classList.remove("btn-selected")
      );
      if (type === "income") btnIncome.classList.add("btn-selected");
      if (type === "expense") btnExpense.classList.add("btn-selected");
      if (type === "saving") btnSaving.classList.add("btn-selected");
      selectedType = type;
    }

    btnIncome.onclick = () => {
      entryForm.classList.remove("hidden");
      expenseCategoryBlock.classList.add("hidden");
      selectedMainCategory = null;
      selectedSubCategory = null;
      highlightType("income");
    };

    btnExpense.onclick = () => {
      entryForm.classList.remove("hidden");
      expenseCategoryBlock.classList.remove("hidden");
      selectedMainCategory = null;
      selectedSubCategory = null;
      renderMainCategories();
      highlightType("expense");
    };

    btnSaving.onclick = () => {
      entryForm.classList.remove("hidden");
      expenseCategoryBlock.classList.add("hidden");
      selectedMainCategory = null;
      selectedSubCategory = null;
      highlightType("saving");
    };

    setTimeout(() => {
      amountInput.focus();
    }, 100);


    /* =========================================
        æ–°å¢ç´€éŒ„
    ========================================= */
    entryForm.onsubmit = async (e) => { 
      e.preventDefault();
      formError.classList.add("hidden");
      
      const amount = Number(amountInput.value);
      const date = dateInput.value;
      const note = noteInput.value.trim();

      if (!selectedType) return showError("è«‹å…ˆé¸æ“‡ æ”¶å…¥ / æ”¯å‡º / å„²è“„ é¡å‹ã€‚");
      if (amount <= 0 || !date) return showError("è«‹ç¢ºèªé‡‘é¡èˆ‡æ—¥æœŸéƒ½æœ‰å¡«å¯«ï¼Œé‡‘é¡éœ€å¤§æ–¼ 0ã€‚");

      let mainCat = null;
      let subCat = null;

      if (selectedType === "expense") {
        if (!selectedMainCategory || !selectedSubCategory)
          return showError("æ”¯å‡ºè«‹é¸æ“‡ä¸»è¦åˆ†é¡èˆ‡å­åˆ†é¡ã€‚");
        mainCat = selectedMainCategory;
        subCat = selectedSubCategory;
      }

      const id = Date.now().toString();

      const entry = {
        id,
        type: selectedType,
        amount,
        date,
        note,
        mainCategory: mainCat,
        subCategory: subCat,
        createdAt: new Date().toISOString(),
      };

      entries.push(entry);
      saveEntries();
      
      // æ›´æ–°ç•«é¢
      render(); 

      const success = await sendActionToSheet(entry);
     
      if (success) {
        amountInput.value = "";
        noteInput.value = "";
      }
    }; 

 
    /* =========================================
        éæ¿¾ç•¶æœˆè³‡æ–™
    ========================================= */
    function getFilteredEntries() {
      const month = monthFilter.value;
      return entries
        .filter((e) => e.date?.startsWith(month))
        .sort((a, b) =>
          (b.date + b.createdAt).localeCompare(a.date + a.createdAt)
        );
    }

    /* =========================================
        Render ä¸»æ§
    ========================================= */
    function render() {
      const list = getFilteredEntries();
      renderSummary(list);
      renderList(list);
      renderCategoryBudgetStatus(list);
      renderExpensePieChart(list);
      
      // NEW: æ¯æ¬¡ render ä¹Ÿè¦æ›´æ–°ä¸€ä¸‹æ¸…å–®çš„æ•¸å­— (å› ç‚ºæœ¬æœˆæ”¶å…¥å¯èƒ½è®Šäº†)
      let totalBills = 0;
      fixedBills.forEach(b => totalBills += Number(b.amount));
      updateBillCalc(totalBills);
    }

    /* =========================================
        åˆ†é¡é ç®—ç‹€æ…‹
    ========================================= */
    function renderCategoryBudgetStatus(list) {
      categoryBudgetStatusBox.innerHTML = "";

      const categorySpent = {};
      list.forEach((e) => {
        if (e.type === "expense" && e.mainCategory) {
          if (!categorySpent[e.mainCategory])
            categorySpent[e.mainCategory] = 0;
          categorySpent[e.mainCategory] += e.amount;
        }
      });

      Object.keys(categoryBudgets).forEach((cat) => {
        const budget = categoryBudgets[cat] || 0;
        const spent = categorySpent[cat] || 0;

        if (!budget && !spent) return;

        const remain = budget - spent;
        const isOver = remain < 0;

        const row = document.createElement("div");
        row.className = "p-2 rounded-lg text-xs";

        row.innerHTML = `
          <div class="flex justify-between">
            <span>${cat}</span>
            <span class="${isOver ? "text-red-500 font-semibold" : "text-ink"}">
              å·²èŠ± ${formatMoney(spent)}
              ${
                budget
                  ? `ï½œ${
                      isOver
                        ? `<span class='text-red-500'>è¶…æ”¯ ${formatMoney(Math.abs(remain))}</span>`
                        : `å‰©é¤˜ ${formatMoney(remain)}`
                    }`
                  : ""
              }
            </span>
          </div>
        `;

        categoryBudgetStatusBox.appendChild(row);
      });
    }

    /* =========================================
        Summary
    ========================================= */
    function renderSummary(list) {
      let income = 0,
        saving = 0,
        expense = 0;

      list.forEach((e) => {
        if (e.type === "income") income += e.amount;
        if (e.type === "saving") saving += e.amount;
        if (e.type === "expense") expense += e.amount;
      });

      sumIncome.textContent = formatMoney(income);
      sumSaving.textContent = formatMoney(saving);
      sumExpense.textContent = formatMoney(expense);
    }

    /* =========================================
        æ˜ç´°åˆ—è¡¨
    ========================================= */
    function renderList(list) {
      recordCount.textContent = `å…± ${list.length} ç­†`;
      mobileList.innerHTML = "";

      if (!list.length) {
        emptyHint.classList.remove("hidden");
        return;
      }
      emptyHint.classList.add("hidden");

      list.forEach((e) => {
        const card = document.createElement("div");
        card.className = "bg-milk2 rounded-xl p-3 text-sm";

        let typeText =
          e.type === "income"
            ? "ğŸ’— æ”¶å…¥"
            : e.type === "saving"
            ? "ğŸ· å„²è“„"
            : "ğŸ§¾ æ”¯å‡º";

        card.innerHTML = `
          <div class="flex justify-between items-start gap-2">
            <div>
              <p class="font-medium">${typeText}</p>
              <p class="text-[11px] text-slate-500">
                ${e.date ? e.date.split("T")[0] : ""}
              </p>
              ${
                e.type === "expense"
                  ? `<p class="text-[11px] text-slate-500">${e.mainCategory}ï½œ${e.subCategory || "æœªåˆ†é¡"}</p>`
                  : ""
              }
              <p class="text-[11px] text-slate-400">${e.note || "ï¼ˆç„¡å‚™è¨»ï¼‰"}</p>
            </div>

            <div class="text-right">
              <p class="text-base font-semibold">${formatMoney(e.amount)}</p>
              <button data-id="${e.id}" class="text-[11px] text-red-500 mt-1">åˆªé™¤</button>
            </div>
          </div>
        `;

        mobileList.appendChild(card);
      });

      mobileList.querySelectorAll("button[data-id]").forEach((btn) => {
          btn.onclick = async () => {
              const entryId = btn.dataset.id;
              if (!confirm(`ç¢ºå®šè¦åˆªé™¤é€™ç­† ID: ${entryId} çš„ç´€éŒ„å—ï¼Ÿé›²ç«¯ä¹ŸæœƒåŒæ­¥åˆªé™¤ã€‚`)) {
                  return;
              }

              const deletePayload = { action: 'DELETE', id: entryId };
              const success = await sendActionToSheet(deletePayload);

              if (success) {
                  entries = entries.filter((e) => e.id !== entryId);
                  saveEntries();
                  render();
                  alert("åˆªé™¤æˆåŠŸï¼Œé›²ç«¯èˆ‡æœ¬åœ°å·²åŒæ­¥ï¼");
              } else {
                  alert("é›²ç«¯åˆªé™¤å¤±æ•—ï¼Œæœ¬åœ°ç´€éŒ„ä»ä¿ç•™ã€‚");
              }
          };
      });
    }

    /* =========================================
        é ç®— UI
    ========================================= */
    function renderBudgetInputs() {
      budgetInputs.innerHTML = "";
      Object.keys(categoryData).forEach((cat) => {
        const row = document.createElement("div");
        row.className = "flex justify-between items-center";

        row.innerHTML = `
          <span class="text-sm">${cat}</span>
          <input
            class="w-24 px-2 py-1 rounded-lg border border-slate-300 text-sm"
            type="number"
            data-cat="${cat}"
            value="${categoryBudgets[cat] || ""}"
          />
        `;

        budgetInputs.appendChild(row);
      });
    }

    saveBudgetBtn.onclick = () => {
      const inputs = budgetInputs.querySelectorAll("input");
      inputs.forEach((i) => {
        categoryBudgets[i.dataset.cat] = Number(i.value || 0);
      });
      saveCategoryBudgets();
      alert("åˆ†é¡é ç®—å·²æ›´æ–° âœ“");
    };

    /* é ç®—å±•é–‹ */
    budgetBtn.onclick = () => {
      const isOpen = !budgetContent.classList.contains("hidden");
      budgetContent.classList.toggle("hidden");
      budgetArrow.textContent = isOpen ? "â–¼" : "â–²";
    };

    monthFilter.onchange = render;

    /* =========================================
        æ”¯å‡ºæ˜ç´°æ”¶åˆ
    ========================================= */
    const toggleRecords = document.getElementById("toggleRecords");
    const recordsContent = document.getElementById("recordsContent");
    const recordsArrow = document.getElementById("recordsArrow");
    let recordsOpen = false;

    toggleRecords.addEventListener("click", () => {
      recordsOpen = !recordsOpen;
      recordsContent.classList.toggle("hidden");
      recordsArrow.textContent = recordsOpen ? "â–²" : "â–¼";
    });

    /* =========================================
        åœ“é¤…åœ–
    ========================================= */
    function renderExpensePieChart(list) {
      const expenses = list.filter((e) => e.type === "expense");

      if (!expenses.length) {
        if (pieChart) {
          pieChart.destroy();
          pieChart = null;
        }
        return;
      }

      const categoryMap = {};
      expenses.forEach((e) => {
        if (!categoryMap[e.mainCategory]) categoryMap[e.mainCategory] = 0;
        categoryMap[e.mainCategory] += e.amount;
      });

      const labels = Object.keys(categoryMap);
      const data = Object.values(categoryMap);
      const ctx = document.getElementById("expensePieChart");

      if (pieChart) pieChart.destroy();

      pieChart = new Chart(ctx, {
        type: "pie",
        data: {
          labels: labels,
          datasets: [
            {
              data: data,
              backgroundColor: [
                "#FFB7CE",
                "#FF6C9F",
                "#FFE3ED",
                "#FFD1DC",
                "#FFC7E3",
                "#FF8FB2",
                "#F9A8D4",
                "#FBCFE8"
              ],
              borderWidth: 1
            }
          ]
        },
        options: {
          plugins: {
            legend: {
              display: true,
              position: "bottom",
              labels: { font: { size: 12 } }
            }
          }
        }
      });
    }

    /* åˆå§‹åŒ– */
    init();

  </script>
</body>
</html>