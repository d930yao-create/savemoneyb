<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>bowbowè¨˜å¸³æœ¬</title>

  <!-- åŠ åˆ°ä¸»ç•«é¢æ™‚çš„ App åç¨± -->
  <meta name="apple-mobile-web-app-title" content="bowbowè¨˜å¸³æœ¬">
  <meta name="application-name" content="bowbowè¨˜å¸³æœ¬">

  <!-- APP åœ–ç¤º -->
  <link rel="apple-touch-icon" href="icon.png">
  <link rel="icon" type="image/png" href="icon.png">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            milk: "#FFF7FA",
            milk2: "#FFEFF4",
            berry: "#FF6C9F",
            blush: "#FFB7CE",
            pastel: "#FFE3ED",
            ink: "#2b2b3c",
          },
          boxShadow: {
            soft: "0 0 0 rgba(0,0,0,0)",
          },
        },
      },
    };
  </script>

  <style>
    .slide {
      animation: slideDown .25s ease-out;
    }
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-4px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    button {
      -webkit-tap-highlight-color: transparent;
    }

    input[type="date"],
    input[type="month"] {
      width: 100% !important;
      max-width: 100% !important;
      box-sizing: border-box;
      appearance: none;
      -webkit-appearance: none;
      padding-left: 8px !important;
      padding-right: 8px !important;
    }

    .btn-selected {
      background-color: #FF6C9F !important;
      color: #ffffff !important;
    }

    .shadow-soft {
      box-shadow: none !important;
    }

    .sub-popup {
      position: absolute;
      z-index: 50;
      background: white;
      border: 1px solid #FFD6E8;
      border-radius: 12px;
      padding: 8px;
      display: none;
      flex-wrap: wrap;
      gap: 6px;
      max-width: 160px;
      box-shadow: 0 4px 10px rgba(255, 150, 186, 0.25);
    }
  </style>
</head>

<body class="min-h-screen bg-milk text-ink">
  <div class="max-w-xl mx-auto px-4 py-6 space-y-8">

    <!-- æœ¬æœˆç¸½è¦½ -->
    <section class="bg-white rounded-2xl shadow-soft border border-pastel p-5">
      <h1 class="text-xl font-bold flex items-center gap-2">âœ¨ æœ¬æœˆç¸½è¦½</h1>

      <div class="grid grid-cols-3 text-center mt-4 text-sm">
        <div>
          <p class="text-slate-500">æ”¶å…¥</p>
          <p id="sumIncome" class="text-lg font-semibold text-green-600">$0</p>
        </div>
        <div>
          <p class="text-slate-500">å„²è“„</p>
          <p id="sumSaving" class="text-lg font-semibold text-blue-600">$0</p>
        </div>
        <div>
          <p class="text-slate-500">æ”¯å‡º</p>
          <p id="sumExpense" class="text-lg font-semibold text-red-500">$0</p>
        </div>
      </div>

      <div class="mt-4 flex items-center gap-2">
        <label class="text-xs text-slate-500">æœˆä»½</label>
        <input
          id="monthFilter"
          type="month"
          class="px-2 py-1.5 rounded-xl border border-slate-300 text-xs bg-white"
        />
      </div>

      <!-- åœ“é¤…åœ– -->
      <div class="mt-4">
        <canvas id="expensePieChart" height="130" style="max-width:180px; margin:0 auto;"></canvas>
      </div>
    </section>

    <!-- æ–°å¢ç´€éŒ„ -->
    <section class="bg-white rounded-2xl shadow-soft border border-pastel p-5">
      <h2 class="text-lg font-semibold flex items-center gap-2">ğŸ“ æ–°å¢è¨˜éŒ„</h2>

      <div class="grid grid-cols-3 gap-3 mt-4">
        <button id="btnIncome" type="button"
          class="py-2 rounded-xl bg-milk2 text-ink text-sm font-medium">ğŸ’— æ”¶å…¥</button>
        <button id="btnExpense" type="button"
          class="py-2 rounded-xl bg-milk2 text-ink text-sm font-medium">ğŸ§¾ æ”¯å‡º</button>
        <button id="btnSaving" type="button"
          class="py-2 rounded-xl bg-milk2 text-ink text-sm font-medium">ğŸ· å„²è“„</button>
      </div>

      <form id="entryForm" class="mt-5 space-y-4 hidden slide">
        <div>
          <label class="text-xs">é‡‘é¡</label>
 <input
  id="amountInput"
  type="text"
  inputmode="decimal"
  class="w-full px-3 py-2 rounded-xl border border-slate-300 text-sm"
  placeholder="å¯ç›´æ¥è¼¸å…¥ 100+50*2"
/>
        </div>

        <div>
          <label class="text-xs">æ—¥æœŸ</label>
          <input
            id="dateInput"
            type="date"
            class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300 text-sm"
          />
        </div>

        <!-- æ”¯å‡ºåˆ†é¡ -->
        <div id="expenseCategoryBlock" class="hidden">
          <label class="text-xs">ä¸»è¦åˆ†é¡</label>
          <div id="mainCategoryButtons" class="grid grid-cols-3 gap-2 mt-2 text-xs"></div>
        </div>

        <div>
          <label class="text-xs">å‚™è¨»</label>
          <input
            id="noteInput"
            type="text"
            maxlength="40"
            class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300 text-sm"
            placeholder="å¯ç•™ç™½"
          />
        </div>

        <button
          type="submit"
          class="w-full py-2.5 bg-berry text-white rounded-xl shadow-soft text-sm"
        >
          ï¼‹ åŠ å…¥ç´€éŒ„
        </button>
        <p id="formError" class="text-xs text-red-500 hidden"></p>
      </form>
    </section>

    <!-- æ”¯å‡ºæ˜ç´° -->
    <section class="p-4 bg-white rounded-xl border border-pastel">
      <button
        id="toggleRecords"
        class="w-full flex justify-between items-center py-2 px-3 bg-milk2 rounded-xl text-sm font-semibold"
      >
        <span>ğŸ“‹ æœ¬æœˆæ”¯å‡ºæ˜ç´°</span>
        <span id="recordsArrow">â–¼</span>
      </button>

      <div id="recordsContent" class="mt-3 space-y-2 hidden">
        <div id="recordCount" class="text-xs text-slate-500"></div>
        <div id="mobileList" class="space-y-3"></div>
        <p id="emptyHint" class="text-xs text-slate-400 mt-2 hidden">ç›®å‰æ²’æœ‰ç´€éŒ„ã€‚</p>
      </div>
    </section>

    <!-- åˆ†é¡é ç®— -->
    <section class="p-4 bg-white rounded-xl border border-pastel mt-4">
      <button
        id="toggleBudgetBtn"
        class="w-full flex justify-between items-center py-2 px-3 bg-milk2 rounded-xl text-sm font-semibold"
      >
        <span>ğŸ“‚ åˆ†é¡é ç®—ç®¡ç†</span>
        <span id="budgetArrow">â–¼</span>
      </button>

      <div id="budgetContent" class="mt-3 hidden">
        <div id="budgetInputs" class="space-y-2"></div>
        <button
          id="saveBudgetBtn"
          class="mt-3 w-full bg-pink-300 text-white py-2 rounded-xl"
        >
          å„²å­˜åˆ†é¡é ç®—
        </button>
      </div>
    </section>

  </div>

  <!-- åˆ†é¡é ç®—ç‹€æ…‹ -->
  <div id="categoryBudgetStatus" class="space-y-1 mt-3 max-w-xl mx-auto px-4"></div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- ä¸»ç¨‹å¼ JS -->
  <script>
    /* ------- åˆ†é¡è³‡æ–™ ------- */
    const categoryData = {
      "ğŸ± é£²é£Ÿ": ["æ—©é¤", "åˆé¤", "æ™šé¤", "é»å¿ƒ", "å®µå¤œ", "å°åƒ", "é£²æ–™", "å…¶ä»–"],
      "ğŸš— äº¤é€š": ["å¤§çœ¾é‹è¼¸", "åŠ æ²¹", "Uberï¼è¨ˆç¨‹è»Š", "åœè»Šè²»", "å…¶ä»–"],
      "ğŸ›’ ç”Ÿæ´»": ["å€‹äººç”¨å“", "å®¶ç”¨æ¸…æ½”ç”¨å“", "è¡›ç”Ÿç”¨å“", "æ–‡å…·å°ç‰©", "äº”é‡‘å·¥å…·", "å…¶ä»–"],
      "ğŸ›ï¸ è³¼ç‰©": ["è¡£æœ", "é‹å­", "é…ä»¶", "ç¾å¦", "ä¿é¤Šå“", "å±…å®¶å°ç‰©", "å…¶ä»–"],
      "ğŸ’³ å¸³å–®": ["å¡è²»", "æ‰‹æ©Ÿè²»", "å¥ä¿è²»", "æˆ¿ç§Ÿ", "é›»è²»", "æ°´è²»", "ç¶²è·¯", "å…¶ä»–"],
      "ğŸ± è²“å’ª": ["ç½é ­", "ä¹¾ä¹¾", "é›¶é£Ÿ", "è²“ç ‚", "ç©å…·", "é é˜²é‡ï¼é†«ç™‚", "ç”¨å“", "å…¶ä»–"],
      "ğŸ’– ç¾å®¹": ["ç¾ç”²", "ç¾ç«", "è‡‰éƒ¨ä¿é¤Š", "é ­é«®", "å…¶ä»–"],
      "ğŸ® å¨›æ¨‚": ["é›»å½±", "KTV", "éŠæˆ²", "èšæœƒ", "é–±è®€ï¼å­¸ç¿’", "å…¶ä»–"],
      "ğŸ¥ é†«ç™‚": ["çœ‹è¨º", "è—¥å“", "å¥åº·æª¢æŸ¥", "å…¶ä»–é†«ç™‚"],
      "âœˆï¸ æ—…éŠ": ["ä½å®¿", "äº¤é€š", "é–€ç¥¨", "ä¼´æ‰‹ç¦®", "å…¶ä»–"],
      "ğŸ€ å…¶ä»–": ["è‡¨æ™‚é–‹éŠ·", "å°é¡èŠ±è²»", "å…¶ä»–"]
    };

    const STORAGE_KEY = "cute-book-entries-v2";
    const CATEGORY_BUDGET_KEY = "cute-budget-category-v1";

    /* ------- DOM ------- */
    const sumIncome = document.getElementById("sumIncome");
    const sumSaving = document.getElementById("sumSaving");
    const sumExpense = document.getElementById("sumExpense");

    const monthFilter = document.getElementById("monthFilter");
    const btnIncome = document.getElementById("btnIncome");
    const btnExpense = document.getElementById("btnExpense");
    const btnSaving = document.getElementById("btnSaving");

    const entryForm = document.getElementById("entryForm");
    const amountInput = document.getElementById("amountInput");
    const dateInput = document.getElementById("dateInput");
    const noteInput = document.getElementById("noteInput");
    const formError = document.getElementById("formError");

    const expenseCategoryBlock = document.getElementById("expenseCategoryBlock");
    const mainCategoryButtons = document.getElementById("mainCategoryButtons");

    const recordCount = document.getElementById("recordCount");
    const mobileList = document.getElementById("mobileList");
    const emptyHint = document.getElementById("emptyHint");

    const budgetInputs = document.getElementById("budgetInputs");
    const saveBudgetBtn = document.getElementById("saveBudgetBtn");
    const budgetBtn = document.getElementById("toggleBudgetBtn");
    const budgetContent = document.getElementById("budgetContent");
    const budgetArrow = document.getElementById("budgetArrow");

    const categoryBudgetStatusBox = document.getElementById("categoryBudgetStatus");

    /* ------- ç‹€æ…‹ ------- */
    let entries = [];
    let selectedType = null;
    let selectedMainCategory = null;
    let selectedSubCategory = null;
    let categoryBudgets = {};
    let pieChart = null;

function showError(msg) {
  formError.textContent = msg;
  formError.classList.remove("hidden");
}

// âš ï¸ æ›¿æ›é€™è£¡ï¼è«‹ä½¿ç”¨æ‚¨åœ¨æ­¥é©Ÿä¸‰ä¸­éƒ¨ç½² Web App å¾Œçš„ã€Œå·²éƒ¨ç½²ç¶²å€ã€
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyePbfCt3HsLD-cKRqZfREIsB07FGiecvFiPiXpGMVHWAdC0_JgmOW0OzvRXlzXqFV4/exec'; 

/**
 * è™•ç†æ–°å¢æˆ–åˆªé™¤è«‹æ±‚
 * @param {object} data - åŒ…å«è³‡æ–™å’Œ action (å¦‚æœæ˜¯åˆªé™¤ï¼Œaction='DELETE') çš„ç‰©ä»¶
 */
async function sendActionToSheet(data) {
    const isDelete = data.action === 'DELETE';
    const actionName = isDelete ? 'åˆªé™¤' : 'æ–°å¢';
    
    try {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(data),
            redirect: 'follow'
        });

        const result = await response.json();

        if (result.status === 'success') {
            console.log(`âœ… è³‡æ–™${actionName}æˆåŠŸ:`, result.message);
            // ä¸è·³å‡ºæˆåŠŸæé†’
            return true;
        } else {
            console.error(`âŒ è³‡æ–™${actionName}å¤±æ•—:`, result.message);
            alert(`${actionName}å¤±æ•—ï¼š${result.message}`); // å»ºè­°ä¿ç•™å¤±æ•—æé†’
            return false;
        }

    } catch (err) {
        console.error(`âŒ ${actionName}æ™‚ç™¼ç”ŸéŒ¯èª¤:`, err);
        alert(`${actionName}ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–å¾Œå°`);
        return false;
    }
}

/**
 * å¾ Google Sheet (doGet) è®€å–æ‰€æœ‰è³‡æ–™ä¸¦æ›´æ–°æœ¬åœ°
 */
async function loadDataFromSheet() {
    console.log('ğŸ”„ å˜—è©¦å¾é›²ç«¯åŒæ­¥è³‡æ–™...');
    try {
        const response = await fetch(SCRIPT_URL, { 
            method: 'GET' 
        });

        const result = await response.json();

        if (result.status === 'success' && Array.isArray(result.data)) {
            // ç”¨é›²ç«¯æœ€æ–°çš„è³‡æ–™è¦†è“‹æœ¬åœ°å„²å­˜
            entries = result.data.map(e => ({
                ...e,
                // ç¢ºä¿é‡‘é¡æ˜¯æ•¸å­—
                amount: parseFloat(e.amount),
                // ç¢ºä¿ ID æ˜¯å­—ä¸²
                id: String(e.id)
            }));
            
            saveEntries(); // å„²å­˜æœ€æ–°çš„é›²ç«¯è³‡æ–™åˆ°æœ¬åœ°
            console.log(`âœ… é›²ç«¯åŒæ­¥å®Œæˆï¼å…±è¼‰å…¥ ${entries.length} ç­†ç´€éŒ„ã€‚`);
            return true;
        } else {
            console.error('âŒ é›²ç«¯è³‡æ–™è®€å–å¤±æ•—:', result.message);
            // è®€å–å¤±æ•—æ™‚ï¼Œç¨‹å¼ä»ç¹¼çºŒä½¿ç”¨æœ¬åœ°è³‡æ–™ (entries é™£åˆ—)
            return false;
        }
    } catch (err) {
        console.error('âŒ é›²ç«¯é€£ç·šéŒ¯èª¤ (GET):', err);
        return false;
    }
}

/* =========================================
    åˆå§‹åŒ–
========================================= */
async function init() { // âš ï¸ å¿…é ˆå°‡ function init() æ”¹ç‚º async function init()
  const t = new Date();
  const yyyy = t.getFullYear();
  const mm = String(t.getMonth() + 1).padStart(2, "0");
  const dd = String(t.getDate()).padStart(2, "0");
  dateInput.value = `${yyyy}-${mm}-${dd}`;
  monthFilter.value = `${yyyy}-${mm}`;

  // å…ˆå¾é›²ç«¯è¼‰å…¥æœ€æ–°çš„è³‡æ–™ (æœƒè¦†è“‹æœ¬åœ°å„²å­˜)
  await loadDataFromSheet(); 
  
  // loadEntries(); // é€™ä¸€è¡Œç¾åœ¨å¯è¨»è§£æ‰æˆ–ç§»é™¤ï¼Œå› ç‚º loadDataFromSheet å·²åŒ…å«æ­¤é‚è¼¯
  loadCategoryBudgets();
  renderBudgetInputs();
  render();
}

// ç¢ºä¿è…³æœ¬æœ€ä¸‹æ–¹çš„ init() ä»è¢«å‘¼å«
// init();

    /* =========================================
        LocalStorage
    ========================================= */
    function loadEntries() {
      const raw = localStorage.getItem(STORAGE_KEY);
      entries = raw ? JSON.parse(raw) : [];
    }

    function saveEntries() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
    }

    function loadCategoryBudgets() {
      const raw = localStorage.getItem(CATEGORY_BUDGET_KEY);
      categoryBudgets = raw ? JSON.parse(raw) : {};
    }

    function saveCategoryBudgets() {
      localStorage.setItem(CATEGORY_BUDGET_KEY, JSON.stringify(categoryBudgets));
    }

    /* =========================================
        Money Format
    ========================================= */
    function formatMoney(n) {
      if (!n) return "$0";
      return (
        "$" +
        n
          .toFixed(0)
          .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      );
    }

    /* =========================================
        åˆ†é¡æ¸²æŸ“
    ========================================= */
    function renderMainCategories() {
      mainCategoryButtons.innerHTML = "";

      let openedPopup = null;

      Object.keys(categoryData).forEach((cat) => {
        const wrap = document.createElement("div");
        wrap.className = "relative";

        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = cat;
        btn.dataset.cat = cat; // è¨˜ä½åŸå§‹åç¨±
        btn.className =
          "w-full py-2 px-2 bg-milk2 border border-pastel rounded-xl text-xs";

        const popup = document.createElement("div");
        popup.className = "sub-popup";

        // å­åˆ†é¡æŒ‰éˆ•
        categoryData[cat].forEach((sub) => {
          const sbtn = document.createElement("button");
          sbtn.type = "button";
          sbtn.textContent = sub;
          sbtn.className =
            "px-3 py-1 bg-white border border-pastel rounded-full text-[11px]";

          sbtn.addEventListener("click", () => {
            selectedMainCategory = cat;
            selectedSubCategory = sub;

            // æ¸…æ‰æ‰€æœ‰å°åˆ†é¡é«˜äº®
            mainCategoryButtons
              .querySelectorAll(".sub-popup button")
              .forEach((b) => b.classList.remove("btn-selected"));

            // é«˜äº®ç¾åœ¨é¸çš„
            sbtn.classList.add("btn-selected");

            // æŠŠæ‰€æœ‰ä¸»åˆ†é¡æ–‡å­—æ¢å¾©åŸæ¨£
            mainCategoryButtons.querySelectorAll("button").forEach((b) => {
              if (b.dataset.cat) b.textContent = b.dataset.cat;
            });

            // æ›´æ–°ç•¶å‰é€™é¡†ä¸»åˆ†é¡é¡¯ç¤ºã€Œä¸»ï½œå­ã€
            btn.textContent = `${cat}ï½œ${sub}`;

            // æ”¶èµ· popup
            popup.style.display = "none";
            openedPopup = null;
          });

          popup.appendChild(sbtn);
        });

        // ä¸»åˆ†é¡æŒ‰éˆ• â†’ å±•é–‹ popup
        btn.addEventListener("click", (e) => {
          e.stopPropagation();

          // é»ä¸»åˆ†é¡æ™‚å…ˆé‡ç½®æ‰€æœ‰ä¸»åˆ†é¡åç¨±
          mainCategoryButtons.querySelectorAll("button").forEach((b) => {
            if (b.dataset.cat) b.textContent = b.dataset.cat;
          });

          // é—œæ‰èˆŠçš„ popup
          if (openedPopup && openedPopup !== popup) {
            openedPopup.style.display = "none";
          }

          const open = popup.style.display !== "flex";
          popup.style.display = open ? "flex" : "none";
          openedPopup = open ? popup : null;
        });

        wrap.appendChild(btn);
        wrap.appendChild(popup);
        mainCategoryButtons.appendChild(wrap);
      });

      // é»å¤–é¢ â†’ æ”¶æ‰
      document.addEventListener("click", (e) => {
        if (!mainCategoryButtons.contains(e.target)) {
          mainCategoryButtons
            .querySelectorAll(".sub-popup")
            .forEach((p) => (p.style.display = "none"));
          openedPopup = null;
        }
      });
    }

    /* =========================================
        é¡å‹åˆ‡æ›
    ========================================= */
    function highlightType(type) {
      [btnIncome, btnExpense, btnSaving].forEach((btn) =>
        btn.classList.remove("btn-selected")
      );
      if (type === "income") btnIncome.classList.add("btn-selected");
      if (type === "expense") btnExpense.classList.add("btn-selected");
      if (type === "saving") btnSaving.classList.add("btn-selected");
      selectedType = type;
    }

    btnIncome.onclick = () => {
      entryForm.classList.remove("hidden");
      expenseCategoryBlock.classList.add("hidden");
      selectedMainCategory = null;
      selectedSubCategory = null;
      highlightType("income");
    };

    btnExpense.onclick = () => {
      entryForm.classList.remove("hidden");
      expenseCategoryBlock.classList.remove("hidden");
      selectedMainCategory = null;
      selectedSubCategory = null;
      renderMainCategories();
      highlightType("expense");
    };

    btnSaving.onclick = () => {
      entryForm.classList.remove("hidden");
      expenseCategoryBlock.classList.add("hidden");
      selectedMainCategory = null;
      selectedSubCategory = null;
      highlightType("saving");
    };

/* =========================================
    æ–°å¢ç´€éŒ„
========================================= */
// é€™è£¡å¿…é ˆæ˜¯ async æ‰èƒ½ä½¿ç”¨ await sendDataToSheet
entryForm.onsubmit = async (e) => { 
  e.preventDefault();

  formError.classList.add("hidden");
if (!calculateAmountIfNeeded()) return;
const amount = Number(amountInput.value);
  const date = dateInput.value;
  const note = noteInput.value.trim();

  if (!selectedType)
    return showError("è«‹å…ˆé¸æ“‡ æ”¶å…¥ / æ”¯å‡º / å„²è“„ é¡å‹ã€‚");

  if (amount <= 0 || !date)
    return showError("è«‹ç¢ºèªé‡‘é¡èˆ‡æ—¥æœŸéƒ½æœ‰å¡«å¯«ï¼Œé‡‘é¡éœ€å¤§æ–¼ 0ã€‚");

  let mainCat = null;
  let subCat = null;

  if (selectedType === "expense") {
    if (!selectedMainCategory || !selectedSubCategory)
      return showError("æ”¯å‡ºè«‹é¸æ“‡ä¸»è¦åˆ†é¡èˆ‡å­åˆ†é¡ã€‚");
    mainCat = selectedMainCategory;
    subCat = selectedSubCategory;
  }

  const id = Date.now().toString();

  const entry = {
    id,
    type: selectedType,
    amount,
    date,
    note,
    mainCategory: mainCat,
    subCategory: subCat,
    createdAt: new Date().toISOString(),
  };

  entries.push(entry);
  saveEntries();

  // 1. ç­‰å¾…é›²ç«¯åŒæ­¥çµæœ
const success = await sendActionToSheet(entry);
 
  // 2. åªæœ‰åœ¨é›²ç«¯åŒæ­¥æˆåŠŸå¾Œæ‰æ¸…ç©ºè¡¨å–®å’Œæ›´æ–°ç•«é¢
  if (success) {
    amountInput.value = "";
    noteInput.value = "";
    render(); // æ›´æ–°æœ¬åœ°ç•«é¢
  }
}; 

// ----------------------------------------------------
// ç¯„ä¾‹ï¼šå¦‚ä½•å‘¼å«é€™å€‹å‡½å¼ (æ‚¨éœ€è¦å°‡æ­¤é‚è¼¯åµŒå…¥åˆ°æ‚¨çš„è¡¨å–®æäº¤äº‹ä»¶ä¸­)
/*
async function handleFormSubmit(event) {
    event.preventDefault(); // é˜»æ­¢è¡¨å–®é è¨­æäº¤è¡Œç‚º
    
    const inputElement = document.getElementById('amountInput'); // å‡è¨­é€™æ˜¯æ‚¨çš„è¼¸å…¥æ¬„ä½
    
    // æ¨¡æ“¬å¾è¡¨å–®æ”¶é›†åˆ°çš„è³‡æ–™
    const collectedData = {
        date: new Date().toISOString().slice(0, 10), // ä»Šå¤©çš„æ—¥æœŸ
        type: 'expense', 
        mainCategory: 'Food', 
        amount: parseFloat(inputElement.value || 0),
        note: 'æ¸¬è©¦æäº¤'
    };
    
    const success = await sendDataToSheet(collectedData);
    
    if (success) {
        // å¦‚æœåŒæ­¥æˆåŠŸï¼ŒåŸ·è¡Œæ›´æ–°æœ¬åœ°åˆ—è¡¨ã€æ¸…ç©ºè¡¨å–®ç­‰æ“ä½œ
    }
}

// å‡è¨­æ‚¨çš„æäº¤æŒ‰éˆ•æˆ–è¡¨å–® ID ç‚º 'submitForm'
// document.getElementById('submitForm').addEventListener('submit', handleFormSubmit); 
*/
 
    /* =========================================
        éæ¿¾ç•¶æœˆè³‡æ–™
    ========================================= */
    function getFilteredEntries() {
      const month = monthFilter.value;
      return entries
        .filter((e) => e.date?.startsWith(month))
        .sort((a, b) =>
          (b.date + b.createdAt).localeCompare(a.date + a.createdAt)
        );
    }

    /* =========================================
        Render ä¸»æ§
    ========================================= */
    function render() {
      const list = getFilteredEntries();
      renderSummary(list);
      renderList(list);
      renderCategoryBudgetStatus(list);
      renderExpensePieChart(list);
    }

    /* =========================================
        åˆ†é¡é ç®—ç‹€æ…‹
    ========================================= */
    function renderCategoryBudgetStatus(list) {
      categoryBudgetStatusBox.innerHTML = "";

      const categorySpent = {};
      list.forEach((e) => {
        if (e.type === "expense" && e.mainCategory) {
          if (!categorySpent[e.mainCategory])
            categorySpent[e.mainCategory] = 0;
          categorySpent[e.mainCategory] += e.amount;
        }
      });

      Object.keys(categoryBudgets).forEach((cat) => {
        const budget = categoryBudgets[cat] || 0;
        const spent = categorySpent[cat] || 0;

        if (!budget && !spent) return;

        const remain = budget - spent;
        const isOver = remain < 0;

        const row = document.createElement("div");
        row.className = "p-2 rounded-lg text-xs";

        row.innerHTML = `
          <div class="flex justify-between">
            <span>${cat}</span>
            <span class="${isOver ? "text-red-500 font-semibold" : "text-ink"}">
              å·²èŠ± ${formatMoney(spent)}
              ${
                budget
                  ? `ï½œ${
                      isOver
                        ? `<span class='text-red-500'>è¶…æ”¯ ${formatMoney(
                            Math.abs(remain)
                          )}</span>`
                        : `å‰©é¤˜ ${formatMoney(remain)}`
                    }`
                  : ""
              }
            </span>
          </div>
        `;

        categoryBudgetStatusBox.appendChild(row);
      });
    }

    /* =========================================
        Summary
    ========================================= */
    function renderSummary(list) {
      let income = 0,
        saving = 0,
        expense = 0;

      list.forEach((e) => {
        if (e.type === "income") income += e.amount;
        if (e.type === "saving") saving += e.amount;
        if (e.type === "expense") expense += e.amount;
      });

      sumIncome.textContent = formatMoney(income);
      sumSaving.textContent = formatMoney(saving);
      sumExpense.textContent = formatMoney(expense);
    }

    /* =========================================
        æ˜ç´°åˆ—è¡¨
    ========================================= */
    function renderList(list) {
      recordCount.textContent = `å…± ${list.length} ç­†`;
      mobileList.innerHTML = "";

      if (!list.length) {
        emptyHint.classList.remove("hidden");
        return;
      }
      emptyHint.classList.add("hidden");

      list.forEach((e) => {
        const card = document.createElement("div");
        card.className = "bg-milk2 rounded-xl p-3 text-sm";

        let typeText =
          e.type === "income"
            ? "ğŸ’— æ”¶å…¥"
            : e.type === "saving"
            ? "ğŸ· å„²è“„"
            : "ğŸ§¾ æ”¯å‡º";

        card.innerHTML = `
          <div class="flex justify-between items-start gap-2">
            <div>
              <p class="font-medium">${typeText}</p>
<p class="text-[11px] text-slate-500">
  ${e.date ? e.date.split("T")[0] : ""}
</p>
              ${
                e.type === "expense"
                  ? `<p class="text-[11px] text-slate-500">${e.mainCategory}ï½œ${e.subCategory || "æœªåˆ†é¡"}</p>`
                  : ""
              }
              <p class="text-[11px] text-slate-400">${e.note || "ï¼ˆç„¡å‚™è¨»ï¼‰"}</p>
            </div>

            <div class="text-right">
              <p class="text-base font-semibold">${formatMoney(e.amount)}</p>
              <button data-id="${e.id}" class="text-[11px] text-red-500 mt-1">åˆªé™¤</button>
            </div>
          </div>
        `;

        mobileList.appendChild(card);
      });

mobileList.querySelectorAll("button[data-id]").forEach((btn) => {
    btn.onclick = async () => { // âš ï¸ å¿…é ˆå°‡ onclick å‡½å¼æ”¹ç‚º async
        const entryId = btn.dataset.id;

        if (!confirm(`ç¢ºå®šè¦åˆªé™¤é€™ç­† ID: ${entryId} çš„ç´€éŒ„å—ï¼Ÿé›²ç«¯ä¹ŸæœƒåŒæ­¥åˆªé™¤ã€‚`)) {
            return;
        }

        // 1. å‘¼å«é›²ç«¯ API åˆªé™¤è³‡æ–™
        const deletePayload = { action: 'DELETE', id: entryId };
        const success = await sendActionToSheet(deletePayload);

        if (success) {
            // 2. é›²ç«¯æˆåŠŸåˆªé™¤å¾Œï¼Œæ‰æ›´æ–°æœ¬åœ°è³‡æ–™
            entries = entries.filter((e) => e.id !== entryId);
            saveEntries();
            render();
            alert("åˆªé™¤æˆåŠŸï¼Œé›²ç«¯èˆ‡æœ¬åœ°å·²åŒæ­¥ï¼");
        } else {
            alert("é›²ç«¯åˆªé™¤å¤±æ•—ï¼Œæœ¬åœ°ç´€éŒ„ä»ä¿ç•™ã€‚");
        }
    };
});

}
    /* =========================================
        é ç®— UI
    ========================================= */
    function renderBudgetInputs() {
      budgetInputs.innerHTML = "";

      Object.keys(categoryData).forEach((cat) => {
        const row = document.createElement("div");
        row.className = "flex justify-between items-center";

        row.innerHTML = `
          <span class="text-sm">${cat}</span>
          <input
            class="w-24 px-2 py-1 rounded-lg border border-slate-300 text-sm"
            type="number"
            data-cat="${cat}"
            value="${categoryBudgets[cat] || ""}"
          />
        `;

        budgetInputs.appendChild(row);
      });
    }

    saveBudgetBtn.onclick = () => {
      const inputs = budgetInputs.querySelectorAll("input");
      inputs.forEach((i) => {
        categoryBudgets[i.dataset.cat] = Number(i.value || 0);
      });
      saveCategoryBudgets();
      alert("åˆ†é¡é ç®—å·²æ›´æ–° âœ“");
    };

    /* é ç®—å±•é–‹ */
    budgetBtn.onclick = () => {
      const isOpen = !budgetContent.classList.contains("hidden");
      budgetContent.classList.toggle("hidden");
      budgetArrow.textContent = isOpen ? "â–¼" : "â–²";
    };

    monthFilter.onchange = render;

    /* =========================================
        æ”¯å‡ºæ˜ç´°æ”¶åˆ
    ========================================= */
    const toggleRecords = document.getElementById("toggleRecords");
    const recordsContent = document.getElementById("recordsContent");
    const recordsArrow = document.getElementById("recordsArrow");
    let recordsOpen = false;

    toggleRecords.addEventListener("click", () => {
      recordsOpen = !recordsOpen;
      recordsContent.classList.toggle("hidden");
      recordsArrow.textContent = recordsOpen ? "â–²" : "â–¼";
    });

    /* =========================================
        åœ“é¤…åœ–
    ========================================= */
    function renderExpensePieChart(list) {
      const expenses = list.filter((e) => e.type === "expense");

      if (!expenses.length) {
        if (pieChart) {
          pieChart.destroy();
          pieChart = null;
        }
        return;
      }

      const categoryMap = {};
      expenses.forEach((e) => {
        if (!categoryMap[e.mainCategory]) categoryMap[e.mainCategory] = 0;
        categoryMap[e.mainCategory] += e.amount;
      });

      const labels = Object.keys(categoryMap);
      const data = Object.values(categoryMap);
      const ctx = document.getElementById("expensePieChart");

      if (pieChart) pieChart.destroy();

      pieChart = new Chart(ctx, {
        type: "pie",
        data: {
          labels: labels,
          datasets: [
            {
              data: data,
              backgroundColor: [
                "#FFB7CE",
                "#FF6C9F",
                "#FFE3ED",
                "#FFD1DC",
                "#FFC7E3",
                "#FF8FB2",
                "#F9A8D4",
                "#FBCFE8"
              ],
              borderWidth: 1
            }
          ]
        },
        options: {
          plugins: {
            legend: {
              display: true,
              position: "bottom",
              labels: { font: { size: 12 } }
            }
          }
        }
      });
    }

    /* åˆå§‹åŒ– */
    init();

function calculateAmountIfNeeded() {
  const raw = amountInput.value.trim();

  // å¦‚æœæœ‰å« + - * /
  if (/[+\-*/]/.test(raw)) {
    try {
      const result = Function(`return (${raw})`)();
      if (!isNaN(result)) {
        amountInput.value = Math.round(result);
      }
    } catch (err) {
      showError("è¨ˆç®—å¼æœ‰èª¤ï¼Œè«‹ç¢ºèªæ ¼å¼");
      return false;
    }
  }
  return true;
}

  </script>
</body>
</html>
